services:

  nginx:
    image: nginx:alpine
    container_name: nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./logs:/var/log/nginx
    depends_on:
      - todo-web
    networks:
      - traefik_proxy


  traefik:
    profiles:
      - disabled
    image: traefik:v2.11
    container_name: traefik
    restart: unless-stopped
    command:
      # logging
      - "--log.level=Warn"
      # EntryPoints
      - "--entrypoints.web.address=:80"
      # - "--entrypoints.websecure.address=:443"
      # Providers
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=traefik_proxy"
      - "--providers.file.directory=/etc/traefik/config"
      - "--providers.file.watch=true"
      - "--api.dashboard=true"
      - "--accesslog=true"
      - "--accesslog.filepath=/var/log/traefik/access.log"
      - "--accesslog.format=json"
      - "--accesslog.fields.names.StartUTC=drop"
      - "--accesslog.fields.headers.defaultmode=keep"
      - "--ping=true"
      - "--entrypoints.status.address=:8082"
      - "--ping.entrypoint=status"
      - "--metrics.prometheus=true"
      - "--metrics.prometheus.entryPoint=status"
      - "--metrics.prometheus.addEntryPointsLabels=true"
      - "--metrics.prometheus.addRoutersLabels=true"
      - "--metrics.prometheus.addServicesLabels=true"
      
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.localhost`)"
      - "traefik.http.routers.dashboard.entrypoints=web"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.middlewares=auth-dashboard@file"
    ports:
      - "80:80"
      - "443:443"
      - "8082:8082"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./config:/etc/traefik/config
      - ./logs:/var/log/traefik
    networks:
      - traefik_proxy
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: sqlserver
    restart: unless-stopped
    logging:
      driver: "none"
    environment:
      - "ACCEPT_EULA=Y"
      - "MSSQL_PID=Developer"
      - "MSSQL_SA_PASSWORD=YourStrong!Passw0rd"
      - "MSSQL_LOG_LEVEL=WARN"
    ports:
      - "1433:1433"
    volumes:
      - mssql-data:/var/opt/mssql
    networks:
      - traefik_proxy
  todo-api:
    build:
      context: ..
      dockerfile: Todo.Api/Dockerfile
    restart: unless-stopped
    user: root
    container_name: todo-api
    environment:
      - "ASPNETCORE_URLS=http://+:9091"
      - "ConnectionStrings__Default=Server=sqlserver;Database=TodoApiDb;User Id=sa;Password=YourStrong!Passw0rd;TrustServerCertificate=True"
    volumes:
      - dp-keys:/home/app/.aspnet/DataProtection-Keys
    labels:
      - "traefik.enable=true"
      
      - "traefik.http.routers.todo-api.rule=Host(`${APP_DOMAIN}`) && PathPrefix(`/api/todos`)"
      - "traefik.http.routers.todo-api.entrypoints=web"
      - "traefik.http.routers.todo-api.middlewares=api-security@file,forward-headers@file,todo-health-rewrite@file,api-rate-limit@file,retry-default@file"
      - "traefik.http.routers.todo-api.priority=100"
      
      - "traefik.http.services.todo-api.loadbalancer.server.port=9091"
      
      - "traefik.http.services.todo-api.loadbalancer.healthcheck.path=/api/health"
      - "traefik.http.services.todo-api.loadbalancer.healthcheck.interval=5s"
      - "traefik.http.services.todo-api.loadbalancer.healthcheck.timeout=3s"
      - "traefik.http.services.todo-api.loadbalancer.serversTransport=api-transport@file"
    depends_on:
      - sqlserver
    networks:
      - traefik_proxy

  migrator:
    image: mcr.microsoft.com/dotnet/sdk:10.0
    container_name: migrator
    working_dir: /src
    volumes:
      - ..:/src:cached
    logging:
      driver: "none"
    environment:
      - "ConnectionStrings__Default=Server=sqlserver;Database=TodoApiDb;User Id=sa;Password=YourStrong!Passw0rd;TrustServerCertificate=True"
    depends_on:
      - sqlserver
    entrypoint: /bin/bash -c 'set -x; dotnet tool install --tool-path /tmp/dotnet-tools dotnet-ef --version 10.0.1 || true; dotnet restore Todo.Profile --verbosity minimal && dotnet restore Todo.Api --verbosity minimal; CONN_PROFILE="Server=sqlserver;Database=TodoProfileDb;User Id=sa;Password=YourStrong!Passw0rd;TrustServerCertificate=True"; CONN_API="Server=sqlserver;Database=TodoApiDb;User Id=sa;Password=YourStrong!Passw0rd;TrustServerCertificate=True"; for i in $$(seq 1 12); do /tmp/dotnet-tools/dotnet-ef database update --project Todo.Profile --startup-project Todo.Profile --connection "$$CONN_PROFILE" --verbose && break || (echo "Retrying Todo.Profile migration (attempt $$i)"; sleep 5); done; for i in $$(seq 1 12); do /tmp/dotnet-tools/dotnet-ef database update --project Todo.Api --startup-project Todo.Api --connection "$$CONN_API" --verbose && break || (echo "Retrying Todo.Api migration (attempt $$i)"; sleep 5); done'
    networks:
      - traefik_proxy
  todo-web:
    build:
      context: ..
      dockerfile: Todo.Web/Dockerfile
    container_name: todo-web
    restart: unless-stopped
    user: root
    environment:
      - "ASPNETCORE_URLS=http://+:9092"
    volumes:
      - dp-keys:/home/app/.aspnet/DataProtection-Keys
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.todo-web.rule=Host(`${APP_DOMAIN}`)"
      - "traefik.http.routers.todo-web.entrypoints=web"
      - "traefik.http.routers.todo-web.priority=10"
      - "traefik.http.routers.todo-web.middlewares=web-security@file,forward-headers@file,common-compress@file,web-rate-limit@file"
      - "traefik.http.services.todo-web.loadbalancer.server.port=9092"
      - "traefik.http.services.todo-web.loadbalancer.serversTransport=web-transport@file"
    networks:
      - traefik_proxy
  todo-profile:
    build:
      context: ..
      dockerfile: Todo.Profile/Dockerfile
    container_name: todo-profile
    restart: unless-stopped
    user: root
    environment:
      - "ASPNETCORE_URLS=http://+:9093"
      - "ConnectionStrings__Default=Server=sqlserver;Database=TodoProfileDb;User Id=sa;Password=YourStrong!Passw0rd;TrustServerCertificate=True"
    volumes:
      - dp-keys:/home/app/.aspnet/DataProtection-Keys
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.todo-profile.rule=Host(`${APP_DOMAIN}`) && PathPrefix(`/api/auth`)"
      - "traefik.http.routers.todo-profile.entrypoints=web"
      - "traefik.http.routers.todo-profile.priority=100"
      - "traefik.http.routers.todo-profile.middlewares=api-security@file,forward-headers@file,profile-health-rewrite@file,profile-rate-limit@file,retry-default@file"
      - "traefik.http.services.todo-profile.loadbalancer.server.port=9093"
      - "traefik.http.services.todo-profile.loadbalancer.serversTransport=profile-transport@file"
    depends_on:
      - sqlserver
    networks:
      - traefik_proxy
networks:
  traefik_proxy:
    external: true
    
volumes:
  mssql-data:
  dp-keys: